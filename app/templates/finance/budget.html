{% extends "base.html" %}

<!-- <style>
    .expense-details {
        display: none;
    }

    .expense-row.expanded .expense-details {
        display: table-row;
    }

    .toggle-icon-plus {
        display: inline-block;
    }

    .toggle-icon-minus {
        display: none;
    }

    .expense-row.expanded .toggle-icon-plus {
        display: none;
    }

    .expense-row.expanded .toggle-icon-minus {
        display: inline-block;
    }
</style> -->

{% block content %}
<div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
    <div class="px-4 py-6 sm:px-0">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold">Budget Tracker</h1>

            <!-- Date Range Form -->
            <form method="GET" action="{{ url_for('main.budget') }}" class="flex items-center space-x-2">
                <div>
                    <label for="start_date" class="block text-sm font-medium text-gray-700">Start Date</label>
                    <input type="date" id="start_date" name="start_date" value="{{ start_date }}"
                        class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="end_date" class="block text-sm font-medium text-gray-700">End Date</label>
                    <input type="date" id="end_date" name="end_date" value="{{ end_date }}"
                        class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="starting_balance" class="block text-sm font-medium text-gray-700">Starting
                        Balance</label>
                    <div class="relative mt-1 rounded-md shadow-sm">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span class="text-gray-500 sm:text-sm">$</span>
                        </div>
                        <input type="number" name="starting_balance" id="starting_balance" step="0.01"
                            value="{{ starting_balance }}"
                            class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full pl-7 pr-12 sm:text-sm border-gray-300 rounded-md">
                    </div>
                </div>
                <div class="self-end pb-0.5">
                    <button type="submit"
                        class="px-3 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Apply
                    </button>
                </div>
            </form>
        </div>

        <!-- Budget Summary with Period Columns -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">Budget Summary ({{ start_date }} to {{ end_date }})</h2>

            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead>
                        <tr class="bg-gray-50 border-b">
                            <th class="text-left py-2 px-4">Category</th>
                            {% for period in periods %}
                            <th class="text-right py-2 px-4">{{ period.date }}</th>
                            {% endfor %}
                            <th class="text-right py-2 px-4 bg-gray-100">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Starting Balance Row -->
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-2 px-4 font-medium">Starting Balance</td>
                            {% for period in periods %}
                            <td
                                class="text-right py-2 px-4 {% if period_data[period.id].startingBalance >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                ${{ "%.2f"|format(period_data[period.id].startingBalance) }}
                            </td>
                            {% endfor %}
                            <td
                                class="text-right py-2 px-4 {% if summary.startingBalance >= 0 %}text-green-600{% else %}text-red-600{% endif %} bg-gray-100">
                                ${{ "%.2f"|format(summary.startingBalance) }}
                            </td>
                        </tr>

                        <!-- Income Row -->
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-2 px-4 font-medium">Income</td>
                            {% for period in periods %}
                            <td class="text-right py-2 px-4 text-green-600">
                                ${{ "%.2f"|format(period_data[period.id].income.total) }}
                            </td>
                            {% endfor %}
                            <td class="text-right py-2 px-4 font-bold text-green-600 bg-gray-100">
                                ${{ "%.2f"|format(summary.totalIncome) }}
                            </td>
                        </tr>

                        <!-- Expenses Row -->
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-2 px-4 font-medium">Expenses</td>
                            {% for period in periods %}
                            {% set total_expenses = period_data[period.id].expenses.values()|sum %}
                            <td class="text-right py-2 px-4 text-red-600">
                                ${{ "%.2f"|format(total_expenses) }}
                            </td>
                            {% endfor %}
                            <td class="text-right py-2 px-4 font-bold text-red-600 bg-gray-100">
                                ${{ "%.2f"|format(summary.totalExpenses) }}
                            </td>
                        </tr>

                        <!-- Net Row -->
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-2 px-4 font-medium">Net</td>
                            {% for period in periods %}
                            {% set period_income = period_data[period.id].income.total %}
                            {% set period_expenses = period_data[period.id].expenses.values()|sum %}
                            {% set period_net = period_income - period_expenses %}
                            <td
                                class="text-right py-2 px-4 {% if period_net >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                ${{ "%.2f"|format(period_net) }}
                            </td>
                            {% endfor %}
                            <td
                                class="text-right py-2 px-4 {% if summary.net >= 0 %}text-green-600{% else %}text-red-600{% endif %} bg-gray-100">
                                ${{ "%.2f"|format(summary.net) }}
                            </td>
                        </tr>

                        <!-- Projected End Balance Row - Running total accumulated across periods -->
                        <tr class="bg-gray-50 font-bold">
                            <td class="py-2 px-4">Projected End Balance</td>
                            {% for period in periods %}
                            <td
                                class="text-right py-2 px-4 {% if period_data[period.id].endingBalance >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                ${{ "%.2f"|format(period_data[period.id].endingBalance) }}
                            </td>
                            {% endfor %}
                            <td
                                class="text-right py-2 px-4 {% if summary.projectedBalance >= 0 %}text-green-600{% else %}text-red-600{% endif %} bg-gray-100">
                                ${{ "%.2f"|format(summary.projectedBalance) }}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Income Section -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Income</h2>
                <div class="flex space-x-2">
                    <a href="{{ url_for('api.add_one_time_income') }}"
                        class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">
                        Add One-Time Income
                    </a>
                    <a href="{{ url_for('main.add_paycheck') }}"
                        class="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700">
                        Add Paycheck
                    </a>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead>
                        <tr class="bg-gray-50 border-b">
                            <th class="text-left py-2 px-4">Source</th>
                            {% for period in periods %}
                            <th class="text-right py-2 px-4">{{ period.date }}</th>
                            {% endfor %}
                            <th class="text-right py-2 px-4 bg-gray-100">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Calculate income totals -->
                        {% set salary_total = 0 %}
                        {% set phone_stipend_total = 0 %}
                        {% set other_income_total = 0 %}
                        {% set tax_return_total = 0 %}
                        {% set transfer_total = 0 %}

                        {% for period in periods %}
                        {% set salary_total = salary_total + period_data[period.id].income.salary %}
                        {% set phone_stipend_total = phone_stipend_total + period_data[period.id].income.phoneStipend %}
                        {% set other_income_total = other_income_total + period_data[period.id].income.otherIncome %}
                        {% set tax_return_total = tax_return_total + period_data[period.id].income.taxReturn %}
                        {% set transfer_total = transfer_total + period_data[period.id].income.transfer %}
                        {% endfor %}

                        <!-- Salary -->
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-2 px-4">Salary</td>
                            {% for period in periods %}
                            <td class="text-right py-2 px-4">
                                ${{ "%.2f"|format(period_data[period.id].income.salary) }}
                            </td>
                            {% endfor %}
                            <td class="text-right py-2 px-4 bg-gray-100">
                                ${{ "%.2f"|format(salary_total) }}
                            </td>
                        </tr>

                        <!-- Phone Stipend -->
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-2 px-4">Phone Stipend</td>
                            {% for period in periods %}
                            <td class="text-right py-2 px-4">
                                ${{ "%.2f"|format(period_data[period.id].income.phoneStipend) }}
                            </td>
                            {% endfor %}
                            <td class="text-right py-2 px-4 bg-gray-100">
                                ${{ "%.2f"|format(phone_stipend_total) }}
                            </td>
                        </tr>

                        <!-- Other Income -->
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-2 px-4">Other Income</td>
                            {% for period in periods %}
                            <td class="text-right py-2 px-4">
                                ${{ "%.2f"|format(period_data[period.id].income.otherIncome) }}
                            </td>
                            {% endfor %}
                            <td class="text-right py-2 px-4 bg-gray-100">
                                ${{ "%.2f"|format(other_income_total) }}
                            </td>
                        </tr>

                        <!-- Tax Return -->
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-2 px-4">Tax Return</td>
                            {% for period in periods %}
                            <td class="text-right py-2 px-4">
                                ${{ "%.2f"|format(period_data[period.id].income.taxReturn) }}
                            </td>
                            {% endfor %}
                            <td class="text-right py-2 px-4 bg-gray-100">
                                ${{ "%.2f"|format(tax_return_total) }}
                            </td>
                        </tr>

                        <!-- Transfer -->
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-2 px-4">Transfer from Savings</td>
                            {% for period in periods %}
                            <td class="text-right py-2 px-4">
                                ${{ "%.2f"|format(period_data[period.id].income.transfer) }}
                            </td>
                            {% endfor %}
                            <td class="text-right py-2 px-4 bg-gray-100">
                                ${{ "%.2f"|format(transfer_total) }}
                            </td>
                        </tr>

                        <!-- Total Row -->
                        <tr class="bg-gray-50 font-bold">
                            <td class="py-2 px-4">Total</td>
                            {% for period in periods %}
                            <td class="text-right py-2 px-4 text-green-600">
                                ${{ "%.2f"|format(period_data[period.id].income.total) }}
                            </td>
                            {% endfor %}
                            <td class="text-right py-2 px-4 text-green-600 bg-gray-100">
                                ${{ "%.2f"|format(summary.totalIncome) }}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Expenses Section -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Expenses</h2>
                <div>
                    <a href="{{ url_for('main.add_expense') }}"
                        class="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700 mr-2">
                        Add Expense
                    </a>
                    <button id="toggle-debug-mode"
                        class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">
                        Debug Mode
                    </button>
                </div>
            </div>

            <!-- Mount point for React component -->
            <div id="detailed-expense-table">
                <p class="text-center py-4 text-gray-500">Loading expense data...</p>
            </div>

            <!-- Debug info (hidden by default) -->
            <div id="debug-info" class="mt-4 p-4 bg-gray-100 rounded hidden">
                <h3 class="text-lg font-medium mb-2">Debug Information</h3>
                <p><strong>Periods Count:</strong> {{ periods|length }}</p>
                <p><strong>Expenses Count:</strong> {{ all_expenses|length }}</p>

                <div class="mt-4">
                    <button id="view-raw-data" class="px-3 py-1 text-sm bg-gray-600 text-white rounded">
                        View Raw Data
                    </button>
                    <div id="raw-data-container" class="mt-2 hidden">
                        <h4 class="font-medium">Raw Data:</h4>
                        <pre id="raw-data"
                            class="mt-2 p-2 bg-gray-200 rounded text-xs overflow-auto max-h-[300px]"></pre>
                    </div>
                </div>

                <div class="mt-4">
                    <h4 class="font-medium">Sample Period Data:</h4>
                    <pre class="mt-2 p-2 bg-gray-200 rounded text-xs">
        {% if periods and periods|length > 0 %}
        Period 1:
        ID: {{ periods[0].id }}
        Date: {{ periods[0].date }}
        Start Date: {{ periods[0].start_date }}
        End Date: {{ periods[0].end_date }}
        {% else %}
        No period data available
        {% endif %}
                    </pre>

                    <h4 class="font-medium mt-4">Sample Expense Data:</h4>
                    <pre class="mt-2 p-2 bg-gray-200 rounded text-xs">
        {% if all_expenses and all_expenses|length > 0 %}
        Expense 1:
        ID: {{ all_expenses[0].id }}
        Date: {{ all_expenses[0].date }}
        Category: {{ all_expenses[0].category|default('None', true) }}
        Description: {{ all_expenses[0].description|default('None', true) }}
        Amount: {{ all_expenses[0].amount|default(0) }}
        {% else %}
        No expense data available
        {% endif %}
                    </pre>
                </div>
            </div>
        </div>
        {% endblock %}

        {% block scripts %}
        <!-- Setup data for JavaScript -->
        <script>
            // Setup expense data for React - with proper null handling
            window.periodsData = {{ periods_json | safe }};
            window.expensesData = [];

            {% for expense in all_expenses %}
            window.expensesData.push({
                id: {{ expense.id }},
                date: "{{ expense.date.strftime('%Y-%m-%d') }}",
                category: "{{ (expense.category or 'uncategorized')|lower|replace('"', '\\"') }}",
                description: "{{ (expense.description or '')|replace('"', '\\"')|replace("\n", " ") }}",
                amount: {{ expense.amount |default(0) }},
                recurring: {{ 'true' if expense.recurring else 'false' }},
                paid: {{ 'true' if expense.paid else 'false' }}
    });
            {% endfor %}

            // Add period start/end dates to the periods data - with proper null handling
            window.periodsWithDates = [];
            {% for p in periods %}
            window.periodsWithDates.push({
                id: {{ p.id }},
                date: "{{ p.date }}",
                start_date: "{{ p.start_date.strftime('%Y-%m-%d') }}",
                end_date: "{{ p.end_date.strftime('%Y-%m-%d') }}"
    });
            {% endfor %}
        </script>

        <!-- Import external JavaScript file -->
        <script src="{{ url_for('static', filename='js/budget-page.js') }}"></script>
        {% endblock %}